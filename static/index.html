<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text RPG Game</title>
    <link rel="stylesheet" href="static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="container">
      <div id="status">
        <h2>캐릭터 정보</h2>
        <div id="playerStatus"></div>
      </div>
      <div id="log">
        <h2>현재 전투 상황</h2>
        <div id="battleLog"></div>
      </div>
    </div>
    <div id="game-controls">
      <input type="text" id="playerName" placeholder="용사의 이름" />
      <button onclick="startGame()">게임 시작</button>
      <button onclick="attack()">공격</button>
      <button onclick="useItem()">힐링 포션 사용</button>
      <button onclick="viewBattleHistory()">전투 기록 보기</button>
    </div>
    <div id="result"></div>

    <script>
      let playerName = "";
      let playerData = {};
      let currentBattleLog = [];
      let previousBattles = []; // 전투 기록을 저장할 배열

      async function startGame() {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("용사의 이름을 입력하세요.");
        const response = await fetch("/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName }),
        });
        playerData = await response.json();
        currentBattleLog = ["게임이 시작되었습니다!"];
        updateStatus();
        updateBattleLog();
      }

      function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString(); // 현지 시간 형식으로 반환
      }

      async function attack() {
        if (!playerName) return alert("게임을 시작하세요.");
        const response = await fetch("/attack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName }),
        });
        const result = await response.json();

        if (result.status === "Game Over" || result.status === "Victory") {
          playerData = result.player;
          document.getElementById(
            "result"
          ).innerHTML = `<strong>${result.message}</strong>`;
          previousBattles.push(currentBattleLog.join("<br>")); // 현재 전투 로그를 이전 전투 기록에 추가
          currentBattleLog = []; // 현재 전투 로그 초기화
        }

        currentBattleLog = currentBattleLog.concat(
          result.log.map((msg) => `${getCurrentTime()}: ${msg}`)
        );
        currentBattleLog.push(`${getCurrentTime()}: ${result.message}`);

        updateStatus();
        updateBattleLog();
      }

      async function useItem() {
        if (!playerName) return alert("게임을 시작하세요.");
        const response = await fetch("/use-item", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName }),
        });
        const result = await response.json();
        if (result.status === "Item Used") {
          playerData = result.player;
          currentBattleLog.push("힐링 포션 사용 완료!");
        } else {
          currentBattleLog.push("아이템 사용 오류: " + result.message);
        }
        updateStatus();
        updateBattleLog();
      }

      function updateStatus() {
        document.getElementById("playerStatus").innerHTML = `
                ${playerName}의 HP: ${playerData.hp || 100}<br>
                공격력: ${playerData.attack || 10}<br>
                방어력: ${playerData.defense || 5}<br>
                레벨: ${playerData.level || 1}<br>
                경험치: ${playerData.exp || 0}<br>
                인벤토리: ${JSON.stringify(playerData.inventory) || "{}"}
            `;
      }

      function updateBattleLog() {
        const logElement = document.getElementById("battleLog");
        logElement.innerHTML = currentBattleLog.join("<br>");
        logElement.scrollTop = logElement.scrollHeight; // 스크롤을 맨 아래로 이동
      }

      function viewBattleHistory() {
        localStorage.setItem(
          "previousBattles",
          JSON.stringify(previousBattles)
        );
        window.location.href = "/battle-history";
      }
    </script>
  </body>
</html>
