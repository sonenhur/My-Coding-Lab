<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text RPG Game</title>
    <link rel="stylesheet" href="static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="intro">
      <h1>용사의 이야기</h1>
      <p>
        악의 세력이 세계를 위협하고 있습니다. 용사가 되어 이 세상을 구하세요!
      </p>
      <input
        type="text"
        id="playerName"
        placeholder="용사의 이름을 입력하세요"
      />
      <button onclick="startGame()">게임 시작</button>
    </div>

    <div id="game" style="display: none">
      <div id="container">
        <div id="status">
          <h2>캐릭터 정보</h2>
          <div id="playerStatus"></div>
          <h2>몬스터 정보</h2>
          <div id="monsterStatus"></div>
        </div>
        <div id="log">
          <h2>현재 전투 상황</h2>
          <div id="battleLog"></div>
        </div>
      </div>
      <div id="game-controls">
        <button onclick="playerAction('attack')">공격</button>
        <button onclick="playerAction('defend')">방어</button>
        <button onclick="playerAction('use-item')">힐링 포션 사용</button>
        <button onclick="viewBattleHistory()">전투 기록 보기</button>
      </div>
      <div id="result"></div>
    </div>

    <script>
      let playerName = "";
      let playerData = {};
      let monsterData = {};
      let currentBattleLog = [];
      let previousBattles = [];

      function loadGameState() {
        const savedPlayerData = localStorage.getItem("playerData");
        const savedMonsterData = localStorage.getItem("monsterData");
        const savedBattleLog = localStorage.getItem("currentBattleLog");
        const savedPlayerName = localStorage.getItem("playerName");

        if (savedPlayerData && savedMonsterData && savedPlayerName) {
          playerData = JSON.parse(savedPlayerData);
          monsterData = JSON.parse(savedMonsterData);
          currentBattleLog = JSON.parse(savedBattleLog);
          playerName = savedPlayerName;

          document.getElementById("intro").style.display = "none";
          document.getElementById("game").style.display = "block";
          updateStatus();
          updateBattleLog();
        }
      }

      function saveGameState() {
        localStorage.setItem("playerData", JSON.stringify(playerData));
        localStorage.setItem("monsterData", JSON.stringify(monsterData));
        localStorage.setItem(
          "currentBattleLog",
          JSON.stringify(currentBattleLog)
        );
        localStorage.setItem("playerName", playerName);
      }

      window.onload = function () {
        loadGameState();
      };

      window.onbeforeunload = function () {
        saveGameState();
      };

      async function startGame() {
        playerName = document.getElementById("playerName").value.trim();
        if (!playerName) return alert("용사의 이름을 입력하세요.");

        const response = await fetch("/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName }),
        });

        const result = await response.json();
        playerData = result.player;
        monsterData = result.monster;
        currentBattleLog = ["게임이 시작되었습니다!"];
        saveGameState();
        document.getElementById("intro").style.display = "none";
        document.getElementById("game").style.display = "block";
        updateStatus();
        updateBattleLog();
      }

      async function playerAction(action) {
        if (!playerName) return alert("게임을 시작하세요.");

        const response = await fetch(`/${action}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: playerName }),
        });

        const result = await response.json();
        playerData = result.player;
        monsterData = result.monster;
        currentBattleLog = currentBattleLog.concat(result.log || []);
        saveGameState();

        if (result.status === "Game Over" || result.status === "Victory") {
          document.getElementById(
            "result"
          ).innerText = `${result.status}: ${result.message}`;
          previousBattles.push({
            player: playerData,
            monster: monsterData,
            log: currentBattleLog,
            result: result.status,
            timestamp: new Date().toLocaleTimeString(),
          });
          currentBattleLog = [];
          updateBattleLog();
          if (result.status === "Game Over") {
            playerName = "";
            document.getElementById("intro").style.display = "block";
            document.getElementById("game").style.display = "none";
          }
        } else if (result.status === "Defending") {
          document.getElementById("result").innerText = result.message;
          updateStatus();
          updateBattleLog();
        } else {
          updateStatus();
          updateBattleLog();
        }
      }

      function updateStatus() {
        document.getElementById("playerStatus").innerText = `
                이름: ${playerData.name}
                HP: ${playerData.hp}
                공격력: ${playerData.attack}
                방어력: ${playerData.defense}
                레벨: ${playerData.level}
                경험치: ${playerData.exp}
                아이템: ${JSON.stringify(playerData.inventory)}
            `;
        document.getElementById("monsterStatus").innerText = monsterData
          ? `
                    이름: ${monsterData.name}
                    HP: ${monsterData.hp}
                    공격력: ${monsterData.attack}
                    방어력: ${monsterData.defense}
                `
          : "없음";
      }

      function updateBattleLog() {
        const battleLogDiv = document.getElementById("battleLog");
        battleLogDiv.innerHTML = "";
        currentBattleLog.forEach((log) => {
          const logElement = document.createElement("div");
          logElement.innerText = log;
          battleLogDiv.appendChild(logElement);
        });
      }

      function viewBattleHistory() {
        window.location.href = "/battle-history";
      }
    </script>
  </body>
</html>
